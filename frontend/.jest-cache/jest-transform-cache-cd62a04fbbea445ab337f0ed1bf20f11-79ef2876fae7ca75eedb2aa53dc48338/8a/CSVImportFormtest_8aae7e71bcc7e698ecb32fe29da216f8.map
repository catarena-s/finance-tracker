{"version":3,"sources":["E:\\my\\otus\\finance_tracker\\frontend\\__tests__\\components\\CSVImportForm.test.tsx"],"sourcesContent":["/**\r\n * Unit tests — CSVImportForm\r\n * Рендер формы, выбор файла, открытие диалога маппинга, импорт (с моками API).\r\n */\r\nimport React from \"react\";\r\nimport { render, screen, waitFor, act } from \"@testing-library/react\";\r\nimport userEvent from \"@testing-library/user-event\";\r\nimport { CSVImportForm } from \"@/components/csv/CSVImportForm\";\r\nimport { csvApi } from \"@/services/api/csv\";\r\nimport { tasksApi } from \"@/services/api/tasks\";\r\n\r\nconst mockParse = jest.fn((text: string) => {\r\n  const lines = text.trim().split(\"\\n\");\r\n  const header = lines[0]?.split(\",\") ?? [];\r\n  const data = lines.slice(1).map((line) => {\r\n    const values = line.split(\",\");\r\n    return header.reduce(\r\n      (acc, h, i) => ({ ...acc, [h]: values[i] ?? \"\" }),\r\n      {} as Record<string, string>\r\n    );\r\n  });\r\n  return { data, meta: { fields: header } };\r\n});\r\n\r\njest.mock(\"papaparse\", () => ({\r\n  __esModule: true,\r\n  default: { parse: (t: string, _opts?: unknown) => mockParse(t) },\r\n}));\r\n\r\njest.mock(\"@/services/api/csv\", () => ({\r\n  csvApi: {\r\n    importCsv: jest.fn(),\r\n  },\r\n}));\r\n\r\njest.mock(\"@/services/api/tasks\", () => ({\r\n  tasksApi: {\r\n    getStatus: jest.fn(),\r\n  },\r\n}));\r\n\r\nconst mockCsvApi = csvApi as jest.Mocked<typeof csvApi>;\r\n\r\ndescribe(\"CSVImportForm\", () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    mockCsvApi.importCsv.mockResolvedValue({\r\n      taskId: \"\",\r\n      status: \"completed\",\r\n      createdCount: 2,\r\n      errorCount: 0,\r\n    });\r\n  });\r\n\r\n  it(\"renders file picker label\", () => {\r\n    render(<CSVImportForm />);\r\n    expect(screen.getByText(\"Выбрать CSV\")).toBeInTheDocument();\r\n  });\r\n\r\n  it(\"opens mapping dialog after file selection\", async () => {\r\n    const user = userEvent.setup();\r\n    const csvContent = \"amount,date,type,category\\n100,2024-01-01,expense,Food\";\r\n    const file = new File([csvContent], \"test.csv\", { type: \"text/csv\" });\r\n\r\n    let resolveOnload: (() => void) | null = null;\r\n    const onloadDone = new Promise<void>((r) => {\r\n      resolveOnload = r;\r\n    });\r\n    jest.spyOn(FileReader.prototype, \"readAsText\").mockImplementation(function (\r\n      this: FileReader\r\n    ) {\r\n      if (this.onload) {\r\n        this.onload({ target: { result: csvContent } } as ProgressEvent<FileReader>);\r\n      }\r\n      resolveOnload?.();\r\n    });\r\n\r\n    render(<CSVImportForm />);\r\n    const input = document.querySelector('input[type=\"file\"]') as HTMLInputElement;\r\n    await user.upload(input, file);\r\n    await onloadDone;\r\n\r\n    await waitFor(() =>\r\n      expect(screen.getByText(\"Настройка колонок CSV\")).toBeInTheDocument()\r\n    );\r\n    expect(screen.getByRole(\"button\", { name: /применить/i })).toBeInTheDocument();\r\n  });\r\n\r\n  it(\"calls import API and shows result on success\", async () => {\r\n    const user = userEvent.setup();\r\n    const csvContent = \"amount,date,type,category\\n100,2024-01-01,expense,Food\";\r\n    const file = new File([csvContent], \"test.csv\", { type: \"text/csv\" });\r\n\r\n    let resolveOnload: (() => void) | null = null;\r\n    const onloadDone = new Promise<void>((r) => {\r\n      resolveOnload = r;\r\n    });\r\n    jest.spyOn(FileReader.prototype, \"readAsText\").mockImplementation(function (\r\n      this: FileReader\r\n    ) {\r\n      if (this.onload) {\r\n        this.onload({ target: { result: csvContent } } as ProgressEvent<FileReader>);\r\n      }\r\n      resolveOnload?.();\r\n    });\r\n\r\n    render(<CSVImportForm />);\r\n    const input = document.querySelector('input[type=\"file\"]') as HTMLInputElement;\r\n    await user.upload(input, file);\r\n    await act(async () => {\r\n      await onloadDone;\r\n    });\r\n\r\n    await waitFor(() =>\r\n      expect(screen.getByText(\"Настройка колонок CSV\")).toBeInTheDocument()\r\n    );\r\n    await waitFor(() => expect(mockParse).toHaveBeenCalledWith(csvContent));\r\n    await waitFor(() => expect(screen.getByText(/1 строк/)).toBeInTheDocument());\r\n\r\n    await user.click(screen.getByRole(\"button\", { name: /применить/i }));\r\n\r\n    await waitFor(() => expect(screen.getByText(\"Импортировать\")).toBeInTheDocument());\r\n    await user.click(screen.getByText(\"Импортировать\"));\r\n\r\n    await waitFor(() => {\r\n      expect(mockCsvApi.importCsv).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          mapping: expect.objectContaining({\r\n            amount: expect.any(String),\r\n            transactionDate: expect.any(String),\r\n            type: expect.any(String),\r\n            categoryName: expect.any(String),\r\n          }),\r\n          dateFormat: \"%Y-%m-%d\",\r\n        })\r\n      );\r\n    });\r\n\r\n    await waitFor(() => {\r\n      expect(screen.getByText(/Готово: создано 2, ошибок 0/)).toBeInTheDocument();\r\n    });\r\n  });\r\n\r\n  it(\"shows error message when import fails\", async () => {\r\n    mockCsvApi.importCsv.mockRejectedValueOnce(new Error(\"Network error\"));\r\n    const user = userEvent.setup();\r\n    const csvContent = \"amount,date,type,category\\n100,2024-01-01,expense,Food\";\r\n    const file = new File([csvContent], \"test.csv\", { type: \"text/csv\" });\r\n\r\n    let resolveOnload: (() => void) | null = null;\r\n    const onloadDone = new Promise<void>((r) => {\r\n      resolveOnload = r;\r\n    });\r\n    jest.spyOn(FileReader.prototype, \"readAsText\").mockImplementation(function (\r\n      this: FileReader\r\n    ) {\r\n      if (this.onload) {\r\n        this.onload({ target: { result: csvContent } } as ProgressEvent<FileReader>);\r\n      }\r\n      resolveOnload?.();\r\n    });\r\n\r\n    render(<CSVImportForm />);\r\n    const input = document.querySelector('input[type=\"file\"]') as HTMLInputElement;\r\n    await user.upload(input, file);\r\n    await act(async () => {\r\n      await onloadDone;\r\n    });\r\n\r\n    await waitFor(() =>\r\n      expect(screen.getByText(\"Настройка колонок CSV\")).toBeInTheDocument()\r\n    );\r\n    await waitFor(() => expect(screen.getByText(/1 строк/)).toBeInTheDocument());\r\n    await user.click(screen.getByRole(\"button\", { name: /применить/i }));\r\n    await waitFor(() => expect(screen.getByText(\"Импортировать\")).toBeInTheDocument());\r\n    await user.click(screen.getByText(\"Импортировать\"));\r\n\r\n    await waitFor(() => {\r\n      expect(screen.getByText(/Ошибка импорта/)).toBeInTheDocument();\r\n    });\r\n  });\r\n});\r\n"],"names":["jest","mock","__esModule","default","parse","t","_opts","mockParse","csvApi","importCsv","fn","tasksApi","getStatus","text","lines","trim","split","header","data","slice","map","line","values","reduce","acc","h","i","meta","fields","mockCsvApi","describe","beforeEach","clearAllMocks","mockResolvedValue","taskId","status","createdCount","errorCount","it","render","CSVImportForm","expect","screen","getByText","toBeInTheDocument","user","userEvent","setup","csvContent","file","File","type","resolveOnload","onloadDone","Promise","r","spyOn","FileReader","prototype","mockImplementation","onload","target","result","input","document","querySelector","upload","waitFor","getByRole","name","act","toHaveBeenCalledWith","click","objectContaining","mapping","amount","any","String","transactionDate","categoryName","dateFormat","mockRejectedValueOnce","Error"],"mappings":"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"}