{"version":3,"sources":["E:\\my\\otus\\finance_tracker\\frontend\\__tests__\\integration\\transaction-pagination.test.tsx"],"sourcesContent":["/**\r\n * Интеграционные тесты для пагинации транзакций\r\n */\r\n\r\nimport React from \"react\";\r\nimport { render, screen, waitFor } from \"@testing-library/react\";\r\nimport userEvent from \"@testing-library/user-event\";\r\nimport { transactionApi } from \"@/services/api/transactions\";\r\n\r\njest.mock(\"@/services/api/transactions\");\r\n\r\nconst mockTransactionApi = transactionApi as jest.Mocked<typeof transactionApi>;\r\n\r\ndescribe(\"Transaction Pagination\", () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  it(\"should display correct number of pages on initial load\", async () => {\r\n    // Мокаем 22 транзакции (должно быть 3 страницы при pageSize=10)\r\n    const mockTransactions = Array.from({ length: 22 }, (_, i) => ({\r\n      id: `txn-${i}`,\r\n      type: \"expense\" as const,\r\n      amount: 100 + i,\r\n      currency: \"RUB\",\r\n      categoryId: \"cat-1\",\r\n      description: `Transaction ${i}`,\r\n      transactionDate: \"2024-02-15\",\r\n      isRecurring: false,\r\n      createdAt: \"2024-02-15T00:00:00Z\",\r\n      updatedAt: \"2024-02-15T00:00:00Z\",\r\n      category: {\r\n        id: \"cat-1\",\r\n        name: \"Food\",\r\n        color: \"#FF5733\",\r\n      },\r\n    }));\r\n\r\n    mockTransactionApi.getAll.mockResolvedValue({\r\n      data: mockTransactions.slice(0, 10), // Первая страница\r\n      pagination: {\r\n        page: 1,\r\n        pageSize: 10,\r\n        totalPages: 3, // Правильное количество страниц\r\n        totalItems: 22,\r\n      },\r\n    });\r\n\r\n    function TestPagination() {\r\n      const [currentPage, setCurrentPage] = React.useState(1);\r\n      const [pagination, setPagination] = React.useState<{\r\n        totalPages: number;\r\n        totalItems: number;\r\n      } | null>(null);\r\n\r\n      React.useEffect(() => {\r\n        const loadData = async () => {\r\n          const result = await transactionApi.getAll({\r\n            page: currentPage,\r\n            pageSize: 10,\r\n          });\r\n          setPagination({\r\n            totalPages: result.pagination.totalPages,\r\n            totalItems: result.pagination.totalItems,\r\n          });\r\n        };\r\n        loadData();\r\n      }, [currentPage]);\r\n\r\n      return (\r\n        <div>\r\n          <div data-testid=\"current-page\">{currentPage}</div>\r\n          <div data-testid=\"total-pages\">\r\n            {pagination?.totalPages ?? \"loading\"}\r\n          </div>\r\n          <div data-testid=\"total-items\">\r\n            {pagination?.totalItems ?? \"loading\"}\r\n          </div>\r\n          <button onClick={() => setCurrentPage(2)}>Next Page</button>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    render(<TestPagination />);\r\n\r\n    // Ждем загрузки данных\r\n    await waitFor(() => {\r\n      expect(screen.getByTestId(\"total-pages\")).not.toHaveTextContent(\r\n        \"loading\"\r\n      );\r\n    });\r\n\r\n    // Проверяем что отображается правильное количество страниц\r\n    expect(screen.getByTestId(\"total-pages\")).toHaveTextContent(\"3\");\r\n    expect(screen.getByTestId(\"total-items\")).toHaveTextContent(\"22\");\r\n    expect(screen.getByTestId(\"current-page\")).toHaveTextContent(\"1\");\r\n  });\r\n\r\n  it(\"should use local currentPage state instead of pagination.page\", async () => {\r\n    const user = userEvent.setup();\r\n\r\n    // Первый запрос - страница 1\r\n    mockTransactionApi.getAll.mockResolvedValueOnce({\r\n      data: [],\r\n      pagination: {\r\n        page: 1,\r\n        pageSize: 10,\r\n        totalPages: 3,\r\n        totalItems: 22,\r\n      },\r\n    });\r\n\r\n    // Второй запрос - страница 2\r\n    mockTransactionApi.getAll.mockResolvedValueOnce({\r\n      data: [],\r\n      pagination: {\r\n        page: 2,\r\n        pageSize: 10,\r\n        totalPages: 3,\r\n        totalItems: 22,\r\n      },\r\n    });\r\n\r\n    function TestPagination() {\r\n      const [currentPage, setCurrentPage] = React.useState(1);\r\n      const [displayPage, setDisplayPage] = React.useState(1);\r\n\r\n      React.useEffect(() => {\r\n        const loadData = async () => {\r\n          const result = await transactionApi.getAll({\r\n            page: currentPage,\r\n            pageSize: 10,\r\n          });\r\n          // Используем локальный currentPage, а не result.pagination.page\r\n          setDisplayPage(currentPage);\r\n        };\r\n        loadData();\r\n      }, [currentPage]);\r\n\r\n      return (\r\n        <div>\r\n          <div data-testid=\"display-page\">{displayPage}</div>\r\n          <button onClick={() => setCurrentPage(2)}>Go to Page 2</button>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    render(<TestPagination />);\r\n\r\n    // Проверяем начальное состояние\r\n    await waitFor(() => {\r\n      expect(screen.getByTestId(\"display-page\")).toHaveTextContent(\"1\");\r\n    });\r\n\r\n    // Переходим на страницу 2\r\n    await user.click(screen.getByText(\"Go to Page 2\"));\r\n\r\n    // Проверяем что отображается страница 2\r\n    await waitFor(() => {\r\n      expect(screen.getByTestId(\"display-page\")).toHaveTextContent(\"2\");\r\n    });\r\n\r\n    // Проверяем что API был вызван с правильными параметрами\r\n    expect(mockTransactionApi.getAll).toHaveBeenNthCalledWith(1, {\r\n      page: 1,\r\n      pageSize: 10,\r\n    });\r\n    expect(mockTransactionApi.getAll).toHaveBeenNthCalledWith(2, {\r\n      page: 2,\r\n      pageSize: 10,\r\n    });\r\n  });\r\n\r\n  it(\"should handle pagination with filters\", async () => {\r\n    const user = userEvent.setup();\r\n\r\n    mockTransactionApi.getAll.mockResolvedValue({\r\n      data: [],\r\n      pagination: {\r\n        page: 1,\r\n        pageSize: 10,\r\n        totalPages: 2,\r\n        totalItems: 15,\r\n      },\r\n    });\r\n\r\n    function TestPagination() {\r\n      const [currentPage, setCurrentPage] = React.useState(1);\r\n      const [filters, setFilters] = React.useState<{ type: \"expense\" | \"income\" }>({\r\n        type: \"expense\",\r\n      });\r\n      const [pagination, setPagination] = React.useState<{\r\n        totalPages: number;\r\n      } | null>(null);\r\n\r\n      React.useEffect(() => {\r\n        const loadData = async () => {\r\n          const result = await transactionApi.getAll({\r\n            ...filters,\r\n            page: currentPage,\r\n            pageSize: 10,\r\n          });\r\n          setPagination({ totalPages: result.pagination.totalPages });\r\n        };\r\n        loadData();\r\n      }, [currentPage, filters]);\r\n\r\n      return (\r\n        <div>\r\n          <div data-testid=\"current-page\">{currentPage}</div>\r\n          <div data-testid=\"total-pages\">\r\n            {pagination?.totalPages ?? \"loading\"}\r\n          </div>\r\n          <button onClick={() => setCurrentPage(2)}>Next Page</button>\r\n          <button onClick={() => setFilters({ type: \"income\" })}>\r\n            Change Filter\r\n          </button>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    render(<TestPagination />);\r\n\r\n    // Ждем загрузки\r\n    await waitFor(() => {\r\n      expect(screen.getByTestId(\"total-pages\")).toHaveTextContent(\"2\");\r\n    });\r\n\r\n    // Переходим на страницу 2\r\n    await user.click(screen.getByText(\"Next Page\"));\r\n\r\n    await waitFor(() => {\r\n      expect(screen.getByTestId(\"current-page\")).toHaveTextContent(\"2\");\r\n    });\r\n\r\n    // Проверяем что API был вызван с фильтрами и пагинацией\r\n    expect(mockTransactionApi.getAll).toHaveBeenLastCalledWith({\r\n      type: \"expense\",\r\n      page: 2,\r\n      pageSize: 10,\r\n    });\r\n  });\r\n});\r\n"],"names":["jest","mock","mockTransactionApi","transactionApi","describe","beforeEach","clearAllMocks","it","mockTransactions","Array","from","length","_","i","id","type","amount","currency","categoryId","description","transactionDate","isRecurring","createdAt","updatedAt","category","name","color","getAll","mockResolvedValue","data","slice","pagination","page","pageSize","totalPages","totalItems","TestPagination","currentPage","setCurrentPage","React","useState","setPagination","useEffect","loadData","result","div","data-testid","button","onClick","render","waitFor","expect","screen","getByTestId","not","toHaveTextContent","user","userEvent","setup","mockResolvedValueOnce","displayPage","setDisplayPage","click","getByText","toHaveBeenNthCalledWith","filters","setFilters","toHaveBeenLastCalledWith"],"mappings":"AAAA;;CAEC;AAODA,KAAKC,IAAI,CAAC;;;;;8DALQ;wBACsB;kEAClB;8BACS;;;;;;AAI/B,MAAMC,qBAAqBC,4BAAc;AAEzCC,SAAS,0BAA0B;IACjCC,WAAW;QACTL,KAAKM,aAAa;IACpB;IAEAC,GAAG,0DAA0D;QAC3D,gEAAgE;QAChE,MAAMC,mBAAmBC,MAAMC,IAAI,CAAC;YAAEC,QAAQ;QAAG,GAAG,CAACC,GAAGC,IAAO,CAAA;gBAC7DC,IAAI,CAAC,IAAI,EAAED,EAAE,CAAC;gBACdE,MAAM;gBACNC,QAAQ,MAAMH;gBACdI,UAAU;gBACVC,YAAY;gBACZC,aAAa,CAAC,YAAY,EAAEN,EAAE,CAAC;gBAC/BO,iBAAiB;gBACjBC,aAAa;gBACbC,WAAW;gBACXC,WAAW;gBACXC,UAAU;oBACRV,IAAI;oBACJW,MAAM;oBACNC,OAAO;gBACT;YACF,CAAA;QAEAxB,mBAAmByB,MAAM,CAACC,iBAAiB,CAAC;YAC1CC,MAAMrB,iBAAiBsB,KAAK,CAAC,GAAG;YAChCC,YAAY;gBACVC,MAAM;gBACNC,UAAU;gBACVC,YAAY;gBACZC,YAAY;YACd;QACF;QAEA,SAASC;YACP,MAAM,CAACC,aAAaC,eAAe,GAAGC,cAAK,CAACC,QAAQ,CAAC;YACrD,MAAM,CAACT,YAAYU,cAAc,GAAGF,cAAK,CAACC,QAAQ,CAGxC;YAEVD,cAAK,CAACG,SAAS,CAAC;gBACd,MAAMC,WAAW;oBACf,MAAMC,SAAS,MAAMzC,4BAAc,CAACwB,MAAM,CAAC;wBACzCK,MAAMK;wBACNJ,UAAU;oBACZ;oBACAQ,cAAc;wBACZP,YAAYU,OAAOb,UAAU,CAACG,UAAU;wBACxCC,YAAYS,OAAOb,UAAU,CAACI,UAAU;oBAC1C;gBACF;gBACAQ;YACF,GAAG;gBAACN;aAAY;YAEhB,qBACE,sBAACQ;;kCACC,qBAACA;wBAAIC,eAAY;kCAAgBT;;kCACjC,qBAACQ;wBAAIC,eAAY;kCACdf,YAAYG,cAAc;;kCAE7B,qBAACW;wBAAIC,eAAY;kCACdf,YAAYI,cAAc;;kCAE7B,qBAACY;wBAAOC,SAAS,IAAMV,eAAe;kCAAI;;;;QAGhD;QAEAW,IAAAA,cAAM,gBAAC,qBAACb;QAER,uBAAuB;QACvB,MAAMc,IAAAA,eAAO,EAAC;YACZC,OAAOC,cAAM,CAACC,WAAW,CAAC,gBAAgBC,GAAG,CAACC,iBAAiB,CAC7D;QAEJ;QAEA,2DAA2D;QAC3DJ,OAAOC,cAAM,CAACC,WAAW,CAAC,gBAAgBE,iBAAiB,CAAC;QAC5DJ,OAAOC,cAAM,CAACC,WAAW,CAAC,gBAAgBE,iBAAiB,CAAC;QAC5DJ,OAAOC,cAAM,CAACC,WAAW,CAAC,iBAAiBE,iBAAiB,CAAC;IAC/D;IAEAhD,GAAG,iEAAiE;QAClE,MAAMiD,OAAOC,kBAAS,CAACC,KAAK;QAE5B,6BAA6B;QAC7BxD,mBAAmByB,MAAM,CAACgC,qBAAqB,CAAC;YAC9C9B,MAAM,EAAE;YACRE,YAAY;gBACVC,MAAM;gBACNC,UAAU;gBACVC,YAAY;gBACZC,YAAY;YACd;QACF;QAEA,6BAA6B;QAC7BjC,mBAAmByB,MAAM,CAACgC,qBAAqB,CAAC;YAC9C9B,MAAM,EAAE;YACRE,YAAY;gBACVC,MAAM;gBACNC,UAAU;gBACVC,YAAY;gBACZC,YAAY;YACd;QACF;QAEA,SAASC;YACP,MAAM,CAACC,aAAaC,eAAe,GAAGC,cAAK,CAACC,QAAQ,CAAC;YACrD,MAAM,CAACoB,aAAaC,eAAe,GAAGtB,cAAK,CAACC,QAAQ,CAAC;YAErDD,cAAK,CAACG,SAAS,CAAC;gBACd,MAAMC,WAAW;oBACf,MAAMC,SAAS,MAAMzC,4BAAc,CAACwB,MAAM,CAAC;wBACzCK,MAAMK;wBACNJ,UAAU;oBACZ;oBACA,gEAAgE;oBAChE4B,eAAexB;gBACjB;gBACAM;YACF,GAAG;gBAACN;aAAY;YAEhB,qBACE,sBAACQ;;kCACC,qBAACA;wBAAIC,eAAY;kCAAgBc;;kCACjC,qBAACb;wBAAOC,SAAS,IAAMV,eAAe;kCAAI;;;;QAGhD;QAEAW,IAAAA,cAAM,gBAAC,qBAACb;QAER,gCAAgC;QAChC,MAAMc,IAAAA,eAAO,EAAC;YACZC,OAAOC,cAAM,CAACC,WAAW,CAAC,iBAAiBE,iBAAiB,CAAC;QAC/D;QAEA,0BAA0B;QAC1B,MAAMC,KAAKM,KAAK,CAACV,cAAM,CAACW,SAAS,CAAC;QAElC,wCAAwC;QACxC,MAAMb,IAAAA,eAAO,EAAC;YACZC,OAAOC,cAAM,CAACC,WAAW,CAAC,iBAAiBE,iBAAiB,CAAC;QAC/D;QAEA,yDAAyD;QACzDJ,OAAOjD,mBAAmByB,MAAM,EAAEqC,uBAAuB,CAAC,GAAG;YAC3DhC,MAAM;YACNC,UAAU;QACZ;QACAkB,OAAOjD,mBAAmByB,MAAM,EAAEqC,uBAAuB,CAAC,GAAG;YAC3DhC,MAAM;YACNC,UAAU;QACZ;IACF;IAEA1B,GAAG,yCAAyC;QAC1C,MAAMiD,OAAOC,kBAAS,CAACC,KAAK;QAE5BxD,mBAAmByB,MAAM,CAACC,iBAAiB,CAAC;YAC1CC,MAAM,EAAE;YACRE,YAAY;gBACVC,MAAM;gBACNC,UAAU;gBACVC,YAAY;gBACZC,YAAY;YACd;QACF;QAEA,SAASC;YACP,MAAM,CAACC,aAAaC,eAAe,GAAGC,cAAK,CAACC,QAAQ,CAAC;YACrD,MAAM,CAACyB,SAASC,WAAW,GAAG3B,cAAK,CAACC,QAAQ,CAAiC;gBAC3EzB,MAAM;YACR;YACA,MAAM,CAACgB,YAAYU,cAAc,GAAGF,cAAK,CAACC,QAAQ,CAExC;YAEVD,cAAK,CAACG,SAAS,CAAC;gBACd,MAAMC,WAAW;oBACf,MAAMC,SAAS,MAAMzC,4BAAc,CAACwB,MAAM,CAAC;wBACzC,GAAGsC,OAAO;wBACVjC,MAAMK;wBACNJ,UAAU;oBACZ;oBACAQ,cAAc;wBAAEP,YAAYU,OAAOb,UAAU,CAACG,UAAU;oBAAC;gBAC3D;gBACAS;YACF,GAAG;gBAACN;gBAAa4B;aAAQ;YAEzB,qBACE,sBAACpB;;kCACC,qBAACA;wBAAIC,eAAY;kCAAgBT;;kCACjC,qBAACQ;wBAAIC,eAAY;kCACdf,YAAYG,cAAc;;kCAE7B,qBAACa;wBAAOC,SAAS,IAAMV,eAAe;kCAAI;;kCAC1C,qBAACS;wBAAOC,SAAS,IAAMkB,WAAW;gCAAEnD,MAAM;4BAAS;kCAAI;;;;QAK7D;QAEAkC,IAAAA,cAAM,gBAAC,qBAACb;QAER,gBAAgB;QAChB,MAAMc,IAAAA,eAAO,EAAC;YACZC,OAAOC,cAAM,CAACC,WAAW,CAAC,gBAAgBE,iBAAiB,CAAC;QAC9D;QAEA,0BAA0B;QAC1B,MAAMC,KAAKM,KAAK,CAACV,cAAM,CAACW,SAAS,CAAC;QAElC,MAAMb,IAAAA,eAAO,EAAC;YACZC,OAAOC,cAAM,CAACC,WAAW,CAAC,iBAAiBE,iBAAiB,CAAC;QAC/D;QAEA,wDAAwD;QACxDJ,OAAOjD,mBAAmByB,MAAM,EAAEwC,wBAAwB,CAAC;YACzDpD,MAAM;YACNiB,MAAM;YACNC,UAAU;QACZ;IACF;AACF"}