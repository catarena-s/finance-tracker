# Документ требований: Дополнительные функции

## Введение

Этот документ описывает требования к дополнительным функциональным возможностям приложения для управления личными финансами. Включает импорт/экспорт транзакций из CSV, повторяющиеся транзакции (подписки, зарплата) и поддержку мультивалютности.

## Глоссарий

- **Система**: Однопользовательское приложение для управления личными финансами
- **Пользователь**: Единственный пользователь системы
- **Транзакция**: Финансовая операция (доход или расход)
- **CSV**: Формат файла с разделителями-запятыми для табличных данных
- **Шаблон_Транзакции**: Настроенный образец повторяющейся транзакции
- **Основная_Валюта**: Валюта, выбранная для отображения итоговых сумм
- **Курс_Валюты**: Обменный курс между двумя валютами на определенную дату
- **Фоновая_Задача**: Асинхронная операция, выполняемая вне основного потока запроса

## Требования

### Требование 1: Импорт транзакций из CSV

**Пользовательская история:** Как пользователь, я хочу импортировать транзакции из CSV файла, чтобы быстро загрузить данные из других систем или банковских выписок.

#### Критерии приемки

1. WHEN пользователь загружает CSV файл, THE Система SHALL отобразить интерфейс маппинга колонок
2. WHEN пользователь настраивает маппинг колонок CSV на поля транзакции, THE Система SHALL сохранить эти настройки
3. WHEN маппинг настроен, THE Система SHALL отобразить предпросмотр первых 10 строк с применением маппинга
4. WHEN пользователь подтверждает импорт, THE Система SHALL валидировать каждую строку данных
5. WHEN строка содержит невалидные данные, THE Система SHALL пропустить эту строку и добавить её в отчет об ошибках
6. WHEN файл содержит более 1000 строк, THE Система SHALL обработать импорт как фоновую задачу
7. WHEN импорт завершен, THE Система SHALL отобразить отчет с количеством успешно импортированных и пропущенных строк
8. THE Система SHALL валидировать формат суммы (числовое значение)
9. THE Система SHALL валидировать формат даты (ISO 8601 или настраиваемый формат)
10. WHEN категория из CSV не существует в системе, THE Система SHALL создать новую категорию автоматически

### Требование 2: Экспорт транзакций в CSV

**Пользовательская история:** Как пользователь, я хочу экспортировать транзакции в CSV файл, чтобы анализировать данные в других инструментах или создавать резервные копии.

#### Критерии приемки

1. WHEN пользователь запрашивает экспорт, THE Система SHALL предложить выбор между экспортом всех транзакций или текущего фильтра
2. WHEN пользователь выбирает колонки для экспорта, THE Система SHALL включить только выбранные поля в CSV файл
3. WHEN пользователь выбирает формат даты, THE Система SHALL применить этот формат ко всем датам в экспорте
4. THE Система SHALL генерировать CSV файл с корректными заголовками колонок
5. THE Система SHALL экранировать специальные символы в текстовых полях (запятые, кавычки, переносы строк)
6. WHEN экспорт готов, THE Система SHALL инициировать скачивание файла через браузер
7. THE Система SHALL включить в имя файла дату экспорта (например, transactions_2024-01-15.csv)

### Требование 3: Повторяющиеся транзакции

**Пользовательская история:** Как пользователь, я хочу настроить повторяющиеся транзакции, чтобы автоматически учитывать регулярные платежи (подписки, зарплата, аренда).

#### Критерии приемки

1. WHEN пользователь создает шаблон транзакции, THE Система SHALL сохранить все параметры транзакции (сумма, категория, описание)
2. WHEN пользователь настраивает расписание, THE Система SHALL поддерживать частоты: ежедневно, еженедельно, ежемесячно, ежегодно
3. WHEN пользователь указывает дату начала, THE Система SHALL использовать её как первую дату создания транзакции
4. WHERE пользователь указывает дату окончания, THE Система SHALL прекратить создание транзакций после этой даты
5. WHEN наступает запланированное время, THE Система SHALL автоматически создать транзакцию на основе шаблона
6. WHEN автоматическая транзакция создана, THE Система SHALL отметить её как созданную из шаблона
7. WHEN пользователь просматривает список шаблонов, THE Система SHALL отобразить все активные и неактивные шаблоны
8. WHEN пользователь редактирует шаблон, THE Система SHALL применить изменения только к будущим транзакциям
9. WHEN пользователь удаляет шаблон, THE Система SHALL сохранить уже созданные транзакции
10. WHEN пользователь деактивирует шаблон, THE Система SHALL прекратить создание новых транзакций
11. WHEN пользователь редактирует отдельную автоматически созданную транзакцию, THE Система SHALL сохранить изменения только для этой транзакции

### Требование 4: Мультивалютность

**Пользовательская история:** Как пользователь, я хочу работать с транзакциями в разных валютах, чтобы учитывать расходы и доходы в различных валютах.

#### Критерии приемки

1. THE Система SHALL позволить выбрать основную валюту в настройках
2. WHEN пользователь создает транзакцию, THE Система SHALL позволить выбрать валюту из списка поддерживаемых валют
3. WHEN транзакция создается в неосновной валюте, THE Система SHALL автоматически получить текущий курс валюты
4. WHEN курс валюты получен, THE Система SHALL сохранить его вместе с транзакцией
5. WHEN курс валюты недоступен, THE Система SHALL использовать последний известный курс
6. IF курс валюты недоступен и нет последнего известного курса, THEN THE Система SHALL запросить у пользователя ручной ввод курса
7. WHEN пользователь просматривает транзакцию в неосновной валюте, THE Система SHALL отобразить сумму в оригинальной валюте и эквивалент в основной валюте
8. WHEN система генерирует отчеты, THE Система SHALL конвертировать все суммы в основную валюту для расчета итогов
9. THE Система SHALL поддерживать минимум 10 основных мировых валют (USD, EUR, GBP, JPY, CNY, RUB, INR, BRL, CAD, AUD)
10. WHEN пользователь изменяет основную валюту, THE Система SHALL пересчитать все отчеты с использованием новой основной валюты
11. THE Система SHALL обновлять курсы валют ежедневно через внешний API
12. WHEN внешний API недоступен, THE Система SHALL продолжать работу с последними известными курсами

### Требование 5: Интеграция с API курсов валют

**Пользовательская история:** Как система, я должна получать актуальные курсы валют, чтобы обеспечить точную конвертацию сумм.

#### Критерии приемки

1. THE Система SHALL интегрироваться с внешним API курсов валют (exchangerate-api.com или аналогичным)
2. THE Система SHALL кэшировать курсы валют на 24 часа
3. WHEN кэш устарел, THE Система SHALL запросить обновленные курсы
4. WHEN API возвращает ошибку, THE Система SHALL повторить запрос с экспоненциальной задержкой (максимум 3 попытки)
5. IF все попытки неудачны, THEN THE Система SHALL использовать последние кэшированные курсы
6. THE Система SHALL сохранять исторические курсы валют для точности отчетов
7. WHEN пользователь создает транзакцию, THE Система SHALL использовать курс на дату транзакции, а не текущий курс

### Требование 6: Фоновая обработка задач

**Пользовательская история:** Как система, я должна обрабатывать длительные операции в фоновом режиме, чтобы не блокировать пользовательский интерфейс.

#### Критерии приемки

1. WHEN импорт CSV содержит более 1000 строк, THE Система SHALL создать фоновую задачу
2. WHEN фоновая задача создана, THE Система SHALL вернуть пользователю идентификатор задачи
3. WHEN пользователь запрашивает статус задачи, THE Система SHALL вернуть текущее состояние (в очереди, выполняется, завершена, ошибка)
4. WHEN фоновая задача завершена, THE Система SHALL сохранить результат для последующего просмотра
5. THE Система SHALL автоматически запускать задачу создания повторяющихся транзакций ежедневно в 00:00 UTC
6. THE Система SHALL автоматически запускать задачу обновления курсов валют ежедневно в 01:00 UTC
7. WHEN фоновая задача завершается с ошибкой, THE Система SHALL логировать детали ошибки
8. THE Система SHALL ограничивать количество одновременно выполняемых фоновых задач (максимум 5)

### Требование 7: Валидация данных импорта

**Пользовательская история:** Как система, я должна валидировать импортируемые данные, чтобы обеспечить целостность базы данных.

#### Критерии приемки

1. WHEN строка CSV содержит пустую сумму, THE Система SHALL отклонить эту строку
2. WHEN строка CSV содержит нечисловую сумму, THE Система SHALL отклонить эту строку
3. WHEN строка CSV содержит невалидную дату, THE Система SHALL отклонить эту строку
4. WHEN строка CSV содержит дату в будущем, THE Система SHALL принять эту строку (запланированные транзакции)
5. WHEN строка CSV содержит отрицательную сумму для дохода, THE Система SHALL преобразовать её в положительную
6. WHEN строка CSV содержит положительную сумму для расхода, THE Система SHALL преобразовать её в отрицательную
7. WHEN строка CSV не содержит обязательные поля (сумма, дата), THE Система SHALL отклонить эту строку
8. WHEN строка CSV содержит неизвестный код валюты, THE Система SHALL отклонить эту строку
9. THE Система SHALL обрезать пробелы в начале и конце текстовых полей
10. THE Система SHALL ограничивать длину текстовых полей (описание - 500 символов, категория - 100 символов)

### Требование 8: Управление шаблонами транзакций

**Пользовательская история:** Как пользователь, я хочу управлять шаблонами повторяющихся транзакций, чтобы контролировать автоматическое создание транзакций.

#### Критерии приемки

1. WHEN пользователь просматривает список шаблонов, THE Система SHALL отобразить название, сумму, частоту и статус каждого шаблона
2. WHEN пользователь создает шаблон, THE Система SHALL валидировать все обязательные поля
3. WHEN пользователь редактирует шаблон, THE Система SHALL сохранить изменения немедленно
4. WHEN пользователь удаляет шаблон, THE Система SHALL запросить подтверждение
5. WHEN пользователь подтверждает удаление, THE Система SHALL удалить шаблон без удаления созданных транзакций
6. WHEN пользователь активирует деактивированный шаблон, THE Система SHALL возобновить создание транзакций
7. WHEN пользователь просматривает детали шаблона, THE Система SHALL отобразить дату следующего запланированного создания транзакции
8. THE Система SHALL отображать историю транзакций, созданных из каждого шаблона
