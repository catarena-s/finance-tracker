# План реализации: Дополнительные функции

## Обзор

Этот план описывает пошаговую реализацию дополнительных функций для приложения управления личными финансами. Включает импорт/экспорт CSV, повторяющиеся транзакции, мультивалютность и фоновые задачи.

Подход к реализации:
1. Настройка инфраструктуры (Redis, Celery)
2. Реализация моделей данных и миграций
3. Реализация backend сервисов и API
4. Реализация фоновых задач
5. Реализация frontend компонентов
6. Тестирование

## Задачи

- [x] 1. Настройка инфраструктуры и зависимостей
  - Добавить Redis и Celery сервисы в docker-compose.yml
  - Обновить requirements.txt с новыми зависимостями (celery, redis, pandas, hypothesis)
  - Обновить package.json с новыми зависимостями (papaparse, fast-check)
  - Настроить Celery приложение и конфигурацию
  - _Требования: 5.1, 6.5, 6.6_

- [x] 2. Создание моделей данных и миграций БД
  - [x] 2.1 Создать модель RecurringTransaction
    - Определить SQLAlchemy модель с полями (name, amount, currency, category_id, frequency, interval, start_date, end_date, next_occurrence, is_active)
    - Добавить constraints (positive amount, valid frequency, positive interval)
    - Добавить индексы (next_occurrence, is_active)
    - _Требования: 3.1, 3.2_
  
  - [x] 2.2 Создать модели Currency и ExchangeRate
    - Определить модель Currency (code, name, symbol, is_active)
    - Определить модель ExchangeRate (from_currency, to_currency, rate, date)
    - Добавить constraints и индексы
    - _Требования: 4.9, 5.6_
  
  - [x] 2.3 Создать модель TaskResult
    - Определить модель для хранения результатов фоновых задач
    - Добавить поля (task_id, task_type, status, result, error)
    - _Требования: 6.4_
  
  - [x] 2.4 Создать миграции Alembic
    - Создать миграцию для recurring_transactions
    - Создать миграцию для currencies и exchange_rates с seed данными
    - Создать миграцию для task_results и обновления transactions
    - Применить миграции к БД
    - _Требования: 4.9, 5.6_

- [x] 3. Реализация Pydantic схем
  - [x] 3.1 Создать схемы для повторяющихся транзакций
    - RecurringTransactionBase, RecurringTransactionCreate, RecurringTransactionUpdate, RecurringTransaction
    - Добавить валидацию (end_date > start_date, valid frequency)
    - _Требования: 3.1, 3.2, 3.4_
  
  - [x] 3.2 Создать схемы для CSV импорта/экспорта
    - CSVColumnMapping, CSVImportRequest, CSVImportResult, CSVExportRequest
    - _Требования: 1.2, 1.7_
  
  - [x] 3.3 Создать схемы для валют
    - Currency, ExchangeRate, CurrencyBase, ExchangeRateBase
    - _Требования: 4.9_
  
  - [x] 3.4 Создать схемы для задач
    - TaskStatusResponse с полями (task_id, task_type, status, result, error)
    - _Требования: 6.2, 6.3_

- [x] 4. Реализация Repository слоя
  - [x] 4.1 Создать RecurringTransactionRepository
    - Реализовать get_active_due_today() для получения шаблонов к выполнению
    - Реализовать update_next_occurrence() для обновления даты следующего выполнения
    - _Требования: 3.5, 3.7_
  
  - [x] 4.2 Создать CurrencyRepository
    - Реализовать get_by_code() для получения валюты по коду
    - Реализовать get_active_currencies() для списка активных валют
    - _Требования: 4.9_
  
  - [x] 4.3 Создать ExchangeRateRepository
    - Реализовать get_rate() для получения курса на дату
    - Реализовать get_latest_rate() для последнего известного курса
    - Реализовать bulk_create() для массового создания курсов
    - _Требования: 4.3, 4.5, 5.6_

- [x] 5. Реализация Service слоя
  - [x] 5.1 Создать CSVImportService
    - Реализовать import_csv() с проверкой размера файла (>1000 строк → фоновая задача)
    - Реализовать _process_csv() для обработки CSV
    - Добавить валидацию данных (amount, date, required fields)
    - Добавить нормализацию данных (trim whitespace, convert amounts)
    - Добавить автоматическое создание категорий
    - Генерировать отчет с ошибками
    - _Требования: 1.4, 1.5, 1.6, 1.8, 1.9, 1.10, 7.1-7.10_
  
  - [x] 5.2 Написать property тест для CSVImportService
    - **Свойство 1: Валидация и отчетность CSV импорта**
    - **Свойство 2: Нормализация данных CSV импорта**
    - **Свойство 4: Полнота отчета импорта**
    - **Свойство 5: Автоматическое создание категорий при импорте**
    - **Валидирует: Требования 1.4, 1.5, 1.7, 1.8, 1.9, 1.10, 7.5, 7.6, 7.9**
  
  - [x] 5.3 Создать CSVExportService
    - Реализовать export_csv() с фильтрацией транзакций
    - Добавить выборочный экспорт колонок
    - Добавить форматирование дат
    - Добавить экранирование специальных символов
    - Генерировать имя файла с датой
    - _Требования: 2.2, 2.3, 2.4, 2.5, 2.7_
  
  - [x] 5.4 Написать property тесты для CSVExportService
    - **Свойство 6: Выборочный экспорт колонок CSV**
    - **Свойство 7: Форматирование дат в CSV экспорте**
    - **Свойство 8: Наличие заголовков в CSV экспорте**
    - **Свойство 9: Экранирование специальных символов в CSV**
    - **Свойство 10: Формат имени файла экспорта**
    - **Валидирует: Требования 2.2, 2.3, 2.4, 2.5, 2.7**
  
  - [x] 5.5 Создать RecurringTransactionService
    - Реализовать create_recurring_transaction() с валидацией
    - Реализовать update_recurring_transaction() с пересчетом next_occurrence
    - Реализовать delete_recurring_transaction()
    - Реализовать process_due_recurring_transactions() для создания транзакций
    - Реализовать _calculate_next_occurrence() для расчета следующей даты
    - _Требования: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.8, 3.9, 3.10_
  
  - [x] 5.6 Написать property тесты для RecurringTransactionService
    - **Свойство 11: Сохранение параметров шаблона транзакции**
    - **Свойство 12: Поддержка частот расписания**
    - **Свойство 13: Первая дата выполнения шаблона**
    - **Свойство 14: Прекращение создания после даты окончания**
    - **Свойство 15: Автоматическое создание транзакций из шаблонов**
    - **Свойство 17: Независимость шаблонов и созданных транзакций**
    - **Валидирует: Требования 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.8, 3.9, 3.10, 3.11**
  
  - [x] 5.7 Создать CurrencyService
    - Реализовать get_currencies() для списка валют
    - Реализовать convert_amount() для конвертации между валютами
    - _Требования: 4.8, 4.9_
  
  - [x] 5.8 Создать ExchangeRateService
    - Реализовать update_exchange_rates() с интеграцией внешнего API
    - Добавить retry логику с экспоненциальной задержкой (3 попытки)
    - Добавить fallback к кэшированным курсам
    - Реализовать get_exchange_rate() с кэшированием (TTL 24 часа)
    - _Требования: 4.3, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_
  
  - [x] 5.9 Написать property тесты для CurrencyService и ExchangeRateService
    - **Свойство 20: Автоматическое получение курса валюты**
    - **Свойство 21: Fallback к последнему известному курсу**
    - **Свойство 22: Конвертация в основную валюту для отчетов**
    - **Свойство 24: Кэширование курсов валют**
    - **Свойство 26: Retry логика при ошибках API**
    - **Свойство 27: Сохранение исторических курсов**
    - **Свойство 28: Использование исторических курсов**
    - **Валидирует: Требования 4.3, 4.4, 4.5, 4.8, 4.12, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7**
  
  - [x] 5.10 Создать CurrencyAPIClient
    - Реализовать get_latest_rates() для получения курсов от exchangerate-api.com
    - Добавить обработку ошибок и таймаутов
    - _Требования: 5.1_

- [x] 6. Checkpoint - Убедиться, что все тесты проходят
  - Unit и property тесты проходят; интеграционные требуют БД.

- [x] 7. Реализация Celery задач
  - [x] 7.1 Создать celery_app.py
    - Настроить Celery с Redis broker
    - Настроить Celery Beat расписание (recurring: 00:00 UTC, exchange rates: 01:00 UTC)
    - _Требования: 6.5, 6.6_
  
  - [x] 7.2 Создать import_csv_task
    - Реализовать фоновую задачу импорта CSV
    - Сохранять статус в TaskResult (pending → running → completed/failed)
    - Обрабатывать ошибки и логировать
    - _Требования: 1.6, 6.1, 6.2, 6.4, 6.7_
  
  - [x] 7.3 Создать create_recurring_transactions_task
    - Реализовать ежедневную задачу создания повторяющихся транзакций
    - Вызывать RecurringTransactionService.process_due_recurring_transactions()
    - _Требования: 3.5, 6.5_
  
  - [x] 7.4 Создать update_exchange_rates_task
    - Реализовать ежедневную задачу обновления курсов валют
    - Вызывать ExchangeRateService.update_exchange_rates()
    - _Требования: 4.11, 6.6_
  
  - [x] 7.5 Написать unit тесты для Celery задач
    - Тестировать выполнение задач в eager mode
    - Тестировать сохранение результатов в TaskResult
    - Тестировать обработку ошибок
    - _Требования: 6.2, 6.4, 6.7_

- [x] 8. Реализация API эндпоинтов
  - [x] 8.1 Создать CSV routes
    - POST /api/v1/csv/import для импорта CSV
    - GET /api/v1/csv/export для экспорта CSV
    - Добавить валидацию запросов через Pydantic
    - _Требования: 1.1, 2.1_
  
  - [x] 8.2 Создать recurring transaction routes
    - POST /api/v1/recurring-transactions для создания шаблона
    - GET /api/v1/recurring-transactions для списка шаблонов
    - GET /api/v1/recurring-transactions/{id} для получения шаблона
    - PUT /api/v1/recurring-transactions/{id} для обновления шаблона
    - DELETE /api/v1/recurring-transactions/{id} для удаления шаблона
    - _Требования: 3.1, 3.7, 3.8, 3.9_
  
  - [x] 8.3 Создать currency routes
    - GET /api/v1/currencies для списка валют
    - GET /api/v1/currencies/exchange-rate для получения курса
    - _Требования: 4.9, 5.7_
  
  - [x] 8.4 Создать task routes
    - GET /api/v1/tasks/{task_id}/status для получения статуса задачи
    - _Требования: 6.3_
  
  - [x] 8.5 Написать integration тесты для API эндпоинтов
    - Тестировать полные циклы запрос/ответ
    - Тестировать коды статуса и формат ответов
    - Тестировать обработку ошибок
    - _Требования: все API требования_

- [x] 9. Checkpoint - Убедиться, что все backend тесты проходят
  - Unit и property тесты проходят.

- [x] 10. Реализация Frontend компонентов
  - [x] 10.1 Создать компоненты CSV импорта
    - CSVImportForm для загрузки файла
    - CSVMappingDialog для настройки маппинга колонок
    - CSVPreview для предпросмотра данных
    - Добавить отображение статуса фоновой задачи
    - Добавить отображение отчета об ошибках
    - _Требования: 1.1, 1.2, 1.3, 1.7_
  
  - [x] 10.2 Создать компоненты CSV экспорта
    - CSVExportDialog для выбора фильтров и колонок
    - Добавить выбор формата даты
    - Добавить кнопку скачивания
    - _Требования: 2.1, 2.3, 2.6_
  
  - [x] 10.3 Создать компоненты повторяющихся транзакций
    - RecurringTransactionList для списка шаблонов
    - RecurringTransactionForm для создания/редактирования шаблона
    - RecurringTransactionCard для отображения шаблона
    - Добавить отображение next_occurrence
    - Добавить кнопки активации/деактивации
    - _Требования: 3.1, 3.7, 3.10, 8.1, 8.6, 8.7_
  
  - [x] 10.4 Создать компоненты валют
    - CurrencySelector для выбора валюты
    - CurrencyDisplay для отображения сумм в разных валютах
    - Добавить отображение конвертированных сумм
    - _Требования: 4.1, 4.2, 4.7_
  
  - [x] 10.5 Написать unit тесты для компонентов
    - Тестировать рендеринг компонентов
    - Тестировать взаимодействия пользователя
    - Тестировать обработку ошибок
    - _Требования: все UI требования_

- [x] 11. Реализация Frontend сервисов
  - [x] 11.1 Создать csvService
    - Функции для импорта и экспорта CSV
    - Функции для получения статуса задачи
    - _Требования: 1.1, 2.1, 6.3_
  
  - [x] 11.2 Создать recurringTransactionService
    - CRUD функции для шаблонов
    - _Требования: 3.1, 3.7, 3.8, 3.9_
  
  - [x] 11.3 Создать currencyService
    - Функции для получения списка валют
    - Функции для получения курсов
    - _Требования: 4.9, 5.7_

- [x] 12. E2E тестирование
  - [ ] 12.1 Написать E2E тесты для импорта CSV
    - Тестировать полный поток: загрузка → маппинг → предпросмотр → импорт → результат
    - _Требования: 1.1, 1.2, 1.3, 1.4, 1.7_
  
  - [ ] 12.2 Написать E2E тесты для экспорта CSV
    - Тестировать полный поток: выбор фильтров → выбор колонок → скачивание
    - _Требования: 2.1, 2.2, 2.3, 2.6_
  
  - [x] 12.3 Написать E2E тесты для повторяющихся транзакций
    - Тестировать создание, редактирование, удаление шаблонов
    - Тестировать активацию/деактивацию
    - _Требования: 3.1, 3.8, 3.9, 3.10, 8.6_
  
  - [ ] 12.4 Написать E2E тесты для мультивалютности
    - Тестировать выбор валюты при создании транзакции
    - Тестировать отображение конвертированных сумм
    - _Требования: 4.2, 4.7_

- [x] 13. Финальный checkpoint - Убедиться, что все тесты проходят
  - Unit и property (backend), unit (frontend) проходят; E2E требуют `npx playwright install` и запущенный frontend.

## Примечания

- Задачи, отмеченные `*`, являются опциональными и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и граничные случаи
- Integration и E2E тесты валидируют полные потоки
